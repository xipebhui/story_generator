# 发布任务重试和删除功能测试

这个测试套件全面测试发布任务的重试和删除功能，确保系统正确处理各种状态下的操作。

## 测试覆盖范围

### 1. 重试功能测试
- ✅ 重试失败的任务（应该成功并创建新任务）
- ❌ 重试成功的任务（应该被阻止）  
- ❌ 重试上传中的任务（应该被阻止）
- ❌ 重试不存在的任务（应该返回404）

### 2. 删除功能测试
- ✅ 删除失败的任务（应该成功）
- ✅ 删除成功的任务（应该成功）
- ❌ 删除上传中的任务（应该被阻止）
- ❌ 删除不存在的任务（应该返回404）

### 3. 前端显示验证
- 通过状态端点验证操作后的任务状态
- 确保前端能正确显示任务列表和状态

## 文件结构

```
frontend/
├── test_publish_retry_delete.py  # 主测试脚本
├── run_tests.sh                  # 测试运行脚本
├── test_config.json             # 测试配置文件
├── TEST_README.md               # 本文档
└── test_results.log             # 测试结果日志（运行后生成）
```

## 运行测试

### 方法1: 使用运行脚本（推荐）

```bash
# 确保API服务器正在运行
cd frontend/

# 运行测试
./run_tests.sh
```

### 方法2: 直接运行Python脚本

```bash
# 设置环境变量（可选）
export API_BASE_URL="http://localhost:51082"
export API_KEY="test-api-key-12345"

# 运行测试
python3 test_publish_retry_delete.py
```

### 方法3: 自定义配置

编辑 `test_config.json` 文件修改测试配置，然后运行测试。

## 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `API_BASE_URL` | `http://localhost:51082` | API服务器基础URL |
| `API_KEY` | `test-api-key-12345` | API认证密钥 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

## 测试前提条件

1. **API服务器运行**: 确保 `api_with_db.py` 在指定端口运行
2. **数据库初始化**: 确保数据库表已创建并有测试账号
3. **网络连接**: 测试脚本需要能够访问API服务器

## 测试流程

1. **数据准备阶段**
   - 获取或创建测试账号
   - 创建基础Pipeline任务
   - 创建不同状态的发布任务（failed, success, uploading, pending）

2. **重试功能测试**
   - 测试各种状态下的重试操作
   - 验证正确的成功/失败响应
   - 检查新创建任务的状态

3. **删除功能测试**
   - 测试各种状态下的删除操作
   - 验证正确的成功/失败响应
   - 确认任务确实被删除

4. **前端显示验证**
   - 调用状态端点获取任务列表
   - 验证任务状态显示正确

5. **清理阶段**
   - 删除测试创建的数据
   - 恢复系统到测试前状态

## 测试结果

测试完成后会输出详细的结果汇总：

```
📊 测试结果汇总:
   重试功能测试: ✅ 通过
   删除功能测试: ✅ 通过  
   前端显示验证: ✅ 通过
   整体测试结果: 🎉 成功
```

详细的执行日志会保存在 `test_results.log` 文件中。

## 故障排除

### 常见问题

1. **连接错误**
   ```
   ❌ 无法连接到API服务器
   ```
   - 检查API服务器是否运行
   - 验证URL和端口是否正确

2. **认证失败**
   ```
   ❌ 401 Unauthorized
   ```
   - 检查API_KEY是否正确
   - 确认API服务器认证配置

3. **测试数据不足**
   ```
   ⚠️ 没有找到失败状态的任务进行测试
   ```
   - 检查账号配置是否正确
   - 确认数据库中有足够的测试数据

### 调试模式

设置环境变量启用详细日志：

```bash
export LOG_LEVEL=DEBUG
./run_tests.sh
```

## 自定义测试

可以通过修改 `test_config.json` 来自定义测试行为：

- 启用/禁用特定测试用例
- 修改测试数据数量和内容
- 调整API连接参数
- 设置期望的测试结果

## API端点测试覆盖

| 端点 | 方法 | 测试场景 |
|------|------|----------|
| `/api/publish/retry/{publish_id}` | POST | 重试功能全面测试 |
| `/api/publish/task/{publish_id}` | DELETE | 删除功能全面测试 |
| `/api/publish/status/{publish_id}` | GET | 单个任务状态获取 |
| `/api/publish/status` | GET | 任务列表获取 |
| `/api/publish/create` | POST | 测试数据创建 |
| `/api/pipeline/create` | POST | 基础任务创建 |

## 贡献指南

如需扩展测试功能：

1. 在 `PublishTaskTestSuite` 类中添加新的测试方法
2. 更新 `run_all_tests()` 方法调用新测试
3. 在 `test_config.json` 中添加相应配置
4. 更新本文档说明新功能

## 许可证

本测试套件遵循项目主许可证。