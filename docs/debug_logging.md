# Debug日志功能文档

## 功能概述

图片提示词生成系统现在支持详细的AI对话debug日志，记录每次与AI的输入和输出，便于手动调试和优化提示词。

## 日志位置

日志文件保存在以下路径：
```
logs/
├── [creator_name]/
│   └── [video_id]/
│       └── ai_conversation_YYYYMMDD_HHMMSS.log
```

例如：`logs/test/Xya-j50aqjM/ai_conversation_20250809_122604.log`

## 日志内容

每个日志文件包含：

### 1. 场景提取
- **输入**：完整的场景提取提示词模板 + 故事片段内容
- **输出**：AI返回的场景JSON数据

### 2. 即梦提示词生成
- **输入**：即梦提示词生成模板 + 场景信息JSON
- **输出**：AI生成的即梦提示词JSON

### 3. SD提示词生成（如使用SD模式）
- **输入**：SD提示词生成模板 + 场景信息JSON
- **输出**：AI生成的SD提示词JSON

## 日志格式

```
2025-08-09 12:26:25 [DEBUG] ================================================================================
================================================================================
2025-08-09 12:26:25 [DEBUG] 即梦提示词生成 - 输入
================================================================================
[完整的输入内容]
================================================================================
2025-08-09 12:26:53 [DEBUG] ================================================================================
================================================================================
2025-08-09 12:26:53 [DEBUG] 即梦提示词生成 - 输出
================================================================================
[完整的输出内容]
```

## 使用方法

### 1. 自动生成
运行图片提示词生成时会自动创建日志：
```bash
python generate_image_prompts.py --creator test --video Xya-j50aqjM --segment 1 --generator_type jimeng --art_style 写实摄影风格
```

运行后会看到：
```
2025-08-09 12:26:04 [INFO] Debug日志已启用: logs/test/Xya-j50aqjM/ai_conversation_20250809_122604.log
```

### 2. 查看日志

#### 直接查看文件
```bash
# 查看完整日志
cat logs/test/Xya-j50aqjM/ai_conversation_*.log

# 查看最新日志的前100行
head -100 logs/test/Xya-j50aqjM/ai_conversation_*.log

# 搜索特定内容
grep "场景提取" logs/test/Xya-j50aqjM/ai_conversation_*.log
```

#### 使用查看脚本
```bash
# 查看最新日志的分析
python view_debug_log.py test Xya-j50aqjM
```

## 调试用途

### 1. 分析提示词质量
通过查看输入和输出，可以：
- 验证提示词模板是否正确传递
- 检查场景信息是否完整
- 分析AI理解是否准确

### 2. 优化提示词
根据日志中的对话记录：
- 发现AI理解偏差的原因
- 调整提示词模板的措辞
- 优化场景描述的细节

### 3. 排查问题
当生成结果不理想时：
- 查看具体的输入内容
- 分析AI的响应
- 定位问题所在

## 示例日志片段

### 场景提取输入
```
### 故事片段
镜头从碧蓝的特克斯和凯科斯群岛海面掠过，阳光洒下碎金般的光芒...

### 需要提取的场景数量
1

请分析上述故事片段，提取1个最具视觉表现力的场景，以JSON格式输出。
```

### 即梦提示词输出
```json
{
  "scene_index": 1,
  "scene_title": "伦敦出租屋的困境",
  "jimeng_prompt": {
    "full_prompt": "写实摄影风格，人物肖像摄影。中景特写..."
  }
}
```

## 注意事项

1. **日志文件较大**：每次生成都会产生30-50KB的日志
2. **定期清理**：建议定期清理旧的日志文件
3. **隐私保护**：日志包含故事内容，注意保护隐私
4. **编码问题**：日志使用UTF-8编码，确保查看工具支持

## 技术实现

日志功能通过Python的`logging`模块实现：

```python
# 创建专门的debug logger
debug_logger = logging.getLogger('debug_ai_conversation')
debug_logger.setLevel(logging.DEBUG)

# 设置文件handler
file_handler = logging.FileHandler(log_file, encoding='utf-8')
debug_logger.addHandler(file_handler)

# 记录AI对话
debug_logger.debug("=" * 80)
debug_logger.debug("场景提取 - 输入")
debug_logger.debug("=" * 80)
debug_logger.debug(prompt)
```

## 扩展功能

未来可以添加：
- 日志分析工具，自动提取关键信息
- 性能统计，记录AI响应时间
- 错误追踪，记录失败的原因
- 版本对比，比较不同版本的提示词效果